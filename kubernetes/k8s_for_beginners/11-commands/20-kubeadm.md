# kubeadm
kubeadm - это приложение для установки и обслуживания кластера. Запускается не так часто как kubectl.

[Инструкция по установке](https://kubernetes.io/docs/setup/production-environment/tools/kubeadm/install-kubeadm/)

## kubeadm version

## kubeadm init
Эта подкоманда служит для инициализации кластера.
У нее есть множество флагов, которые уточняют параметры будущего кластера.

[Официальная документация](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/)

В момент инициализации кластера выполняется много работы:
- Выполняется множество проверок перед инициализацией кластера.
- Выпускаются TLS сертификаты для etcd, kube-apiserver.
- Создаются манифесты(конфигурации) для запуска компонентов Kubernetes.
- Загружаются образы компонентов.
- Компоненты Kubernetes запускаются в контейнерах. 

Проверки перед инициализацией кластера определяют потенциальную возможность инициализации кластера.
Эти проверки не гарантируют, что кластер будет нормально инициализирован и запущен.

### Полезные флаги 

- --apiserver-advertise-address — этот адрес будет слушать apiserver, этот IP будет указан в сертификате;
- --apiserver-cert-extra-sans - дополнительные IP или DNS адреса, которые будут указаны в сертификате; 
- --apiserver-bind-port — этот порт будет слушать apiserver;
- --control-plane-endpoint — потребуется для связи с другими мастерами;
- --cri-socket — сокет ContainerRuntime, по умолчанию ищет сам;
- --node-name — название ноды, по умолчанию совпадает с именем сервера(hostname);
- --service-cidr — диапазон адресов для сервисов;
- --pod-network-cidr — диапазон адресов для подов.

`--apiserver-advertise-address` важный параметр именно на эти адреса будут выпущены сертификаты.
При попытке `kubectl` обратиться к другому адресу, доступному на этом же сервере, kube-apiserver ответит отказом в обслуживании.

Диапазоны адресов следует указывать в случаях:
- диапазон по умолчанию пересекается с существующими сетями;
- размер сети по умолчанию недостаточен для создания необходимого числа подов или сервисов.

### Пример использования
```shell script
# Инициализация кластера
kubeadm init \
  --apiserver-advertise-address=10.128.0.16 \
  --control-plane-endpoint=master1
```

После настройки кластера необходимо скопировать параметры доступа к кластеру в отдельный файл `~/.kube/config`.

```shell script
mkdir ~/.kube

cp /etc/kubernetes/admin.conf ~/.kube/config
```

### kubeadm init с подготовленным конфигом
```shell script
kubeadm init --config kubeadm-config.yaml
```

## kubeadm reset
Эта подкоманда служит для сброса настроек кластера. И чаще всего выполняется перед повторной инициализацией.
Например для экспериментов по установке кластера с различными параметрами. 
Необходимо понимать, что сбрасывая настройки кластера вы фактически теряете свой кластер.
Все настройки необходимо произвести заново. Все ноды должны быть подключены заново.

```shell script
# Сброс настроек кластера
kubeadm reset
```

## kubeadm join
Эта команда служит для подключения новой ноды к существующему кластеру.
При инициализации кластера будет выдан токен для подключения к мастеру.
Этот токен по умолчанию действует 24 часа. По истечении этого времени автоматически удаляется.

### Полезные флаги
- --token — токен для подключения к мастеру;
- --control-plane — для подключения в качестве еще одного мастера;

## kubeadm token
Служит для управления токенами подключения к control-plane нодам кластера.

Полезные команды:
- create — создать новый токен;
- list — просмотр существующих токенов;
- delete — удаление токена.

## kubeadm config
Служит для просмотра конфигов инициализации кластера

Полезные команды:
- print init-defaults — просмотр конфига инициализации;
- images list — получение списка служебных конфигов;
- migrate — обновление конфигурации до новой версии.

## kubeadm upgrade
Эта команда служит для обновления версии Kubernetes.
**Всегда** обновляйтесь вооружившись [официальной документацией](https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-upgrade/).
Выберите версию с какой на какую обновляетесь. Ознакомьтесь с инструкцией.
Выберите время с минимальной нагрузкой на кластер. 
Затем по инструкции обновите свой кластер.

Обновляйтесь на одну версию вверх за один раз.

Для просмотра возможных версий Kubernetes выполните следующие команды: 
```shell script
apt update
apt-cache madison kubeadm
```

### kubeadm upgrade plan
Проверяет возможность обновления в рамках патча. И показывает какие компоненты будут обновлены в рамках этого обновления.
Если предварительно было обновлено ПО, то будет показан план обновления на эту версию.

### kubeadm upgrade apply
Обновляет `control plane` ноду.
При обновлении кластера сначала обновляют все `control plane` ноды. И только потом обновляют рабочие ноды.
 
### kubeadm upgrade node
Обновляет `worker` ноду

## kubeadm certs
Эта команда обновляет сертификаты доступа к кластеру.

По умолчанию при установке кластера сертификаты выпускаются на 1 год. 
По истечении этого срока, сертификаты протухают. И получить доступ к управлению кластером нельзя.
Для возобновления доступа необходимо обновить сертификаты. Это сделать довольно легко:

```shell script
kubeadm certs renew all
```
После обновления сертификатов необходимо скопировать их из файла `/etc/kubernetes/admin.conf` в свой файл `~/.kube/config`. 

Если ваш кластер был установлен полностью вручную, то процесс обновления сертификата может быть гораздо более сложным. 
Подробности [тут](https://habr.com/ru/company/southbridge/blog/465733/)

```shell script
# Удалить taint с ноды для возможности запуска рабочей нагрузки на control plane node  
kubectl taint node master1 node-role.kubernetes.io/master-
```
